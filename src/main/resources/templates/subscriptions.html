<!DOCTYPE HTML>
<!--
  ~ Licensed under the EUPL, Version 1.2 or â€“ as soon they will be approved by
  ~ the European Commission - subsequent versions of the EUPL (the "Licence");
  ~ You may not use this work except in compliance with the Licence.
  ~ You may obtain a copy of the Licence at:
  ~
  ~  https://joinup.ec.europa.eu/software/page/eupl
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the Licence is distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the Licence for the specific language governing permissions and
  ~ limitations under the Licence.
  -->

<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Subscriptions</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
</head>
<body>

<div class="subscriptionlist" th:unless="${#lists.isEmpty(allSubscriptions)}">

    <h2><a th:href="@{subscriptions}">List of Subscriptions</a></h2>

    <p>
        Current active subscriptions from this service to receive push messages on
        deviations in traffic.<br/>
        Add new ones or look at the push messages received for existing subscriptions.
    </p>
    <p>
        This is a <mark>demo service</mark>, not intended for real usage - data is not persisted
        and lost at restart!
    </p>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Ids</th>
            <th>Name</th>
            <th>From stops</th>
            <th>To stops</th>
            <th>LineRefs</th>
            <th>Codespace</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="s : ${#lists.sort(allSubscriptions)}">
            <td>Subscription id: <span th:text="${s.id}">id</span><br/>
                type: <span th:text="${s.type}">type</span><br/>
                push Id: <span th:text="${s.pushId}">pushId</span><br/>
                <a th:href="@{messages(id=${s.id})}">Messages: <span th:text="${s.numberOfMessages}">0</span></a>
            </td>
            <td th:text="${s.name}">name</td>
            <td>
                <table>
                    <tbody>
                    <tr th:each="row: ${#lists.sort(s.fromStopPoints)}">
                        <td th:text="${row}">stopplace/quay</td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td>
                <table>
                    <tbody>
                    <tr th:each="row : ${#lists.sort(s.toStopPoints)}">
                        <td th:text="${row}">stopplace/quay</td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td>
                <table>
                    <tbody>
                    <tr th:each="row : ${#lists.sort(s.lineRefs)}">
                        <td th:text="${row}">line</td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td>
                <table>
                    <tbody>
                    <tr th:each="row : ${#lists.sort(s.codespaces)}">
                        <td th:text="${row}">vehicle</td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td>
                <a th:href="@{subscriptions(deleteSubscriptionId=${s.id})}">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div>
    <h2>Add new Subscription</h2>
    <p>
        Find valid ids for stop places and quays at <a href="https://stoppested.entur.org/">stoppested.entur.org</a>.
        Only stops based on national ids will be handled by ukur (ie. starting with "NSR:").
    </p>
    <p>
        New subscriptions will receive push messages after these rules:
        <ul>
            <li>ET messages: If a subscription has one 'From stop' and one 'To stop' affected and in correct order or the journey regards a subscribed LineRef in an
                EstimatedVehicleJourney with delays/cancellations, the entire EstimatedVehicleJourney is pushed after unsubscribed stops/lines are removed to minimize the message size.
                Codespaces are not used at the moment for ET messages (but will be used to specify/limit source of the ET messages in the future).</li>
            <li>SX messages: If one of the stops or line from a subscription is affected by a PtSituationElement, the
                entire PtSituationElement is pushed after affects not regarding the subscription are removed. If codespace(s) is specified, if not limited by stops/lines,
                the PtSituationElement is pushed if it comes from that codespace (as indicated by the participantRef).</li>
        </ul>
    </p>

    <form class="form-horizontal" id="addSubscription" th:action="@{subscriptions#addSubscription}" th:object="${subscription}" method="post">
        <fieldset>
            <div class="form-group">
                <label class="control-label col-sm-2">Name</label>
                <div class="col-sm-10">
                    <input type="text" th:field="*{name}"/>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-2">From Stops</label>
                <div class="col-sm-10">
                    <table>
                        <tbody>
                        <tr th:each="row,rowStat : *{fromStopPoints}">
                            <td>
                                <input readonly="readonly" type="text" th:field="*{fromStopPoints[__${rowStat.index}__]}"/>
                            </td>
                            <td>
                                <button type="submit" name="removeFrom" th:value="${rowStat.index}" class="btn btn-default">Remove stop</button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="from_value"/></td>
                            <td>
                                <button type="submit" name="addFrom" class="btn btn-default">Add stop</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-2">To Stops</label>
                <div class="col-sm-10">
                    <table>
                        <tbody>
                        <tr th:each="row,rowStat : *{toStopPoints}">
                            <td>
                                <input readonly="readonly" type="text" th:field="*{toStopPoints[__${rowStat.index}__]}"/>
                            </td>
                            <td>
                                <button type="submit" name="removeTo" th:value="${rowStat.index}" class="btn btn-default">Remove stop</button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="to_value"/></td>
                            <td>
                                <button type="submit" name="addTo" class="btn btn-default">Add stop</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-2">LineRefs</label>
                <div class="col-sm-10">
                    <table>
                        <tbody>
                        <tr th:each="row,rowStat : *{lineRefs}">
                            <td>
                                <input readonly="readonly" type="text" th:field="*{lineRefs[__${rowStat.index}__]}"/>
                            </td>
                            <td>
                                <button type="submit" name="removeLineRef" th:value="${rowStat.index}" class="btn btn-default">Remove LineRef</button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="lineref_value"/></td>
                            <td>
                                <button type="submit" name="addLineRef" class="btn btn-default">Add LineRef</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-sm-2">Codespaces</label>
                <div class="col-sm-10">
                    <table>
                        <tbody>
                        <tr th:each="row,rowStat : *{codespaces}">
                            <td>
                                <input readonly="readonly" type="text" th:field="*{codespaces[__${rowStat.index}__]}"/>
                            </td>
                            <td>
                                <button type="submit" name="removeCodespace" th:value="${rowStat.index}" class="btn btn-default">Remove Codespace</button>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="codespace_value"/></td>
                            <td>
                                <button type="submit" name="addCodespace" class="btn btn-default">Add Codespace</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <div class="submit col-sm-offset-2 col-sm-10">
                    <button type="submit" name="save" class="btn btn-default">Add Subscription</button>
                </div>
            </div>
        </fieldset>
    </form>
    <a th:href="@{subscriptions}">Refresh page</a>
</div>

</body>
</html>